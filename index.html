<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Floating Speech Notes</title>
  <style>
    /* [Your same CSS here - no changes needed] */
  </style>
</head>
<body>

<div id="container">
  <div id="header">
    <h3>🎙️ Floating Speech Notes</h3>
    <div id="buttons">
      <button id="startBtn">Start</button>
      <button id="clearBtn">Clear</button>
      <button id="closeBtn">×</button>
    </div>
  </div>
  <div id="notes" contenteditable="true" spellcheck="false" aria-label="Speech to text notes"></div>
  <div id="footer">Double-click header to toggle dragging</div>
</div>

<script>
  const container = document.getElementById('container');
  const header = document.getElementById('header');
  let isDragging = false, offsetX, offsetY;

  header.addEventListener('mousedown', (e) => {
    isDragging = true;
    offsetX = e.clientX - container.offsetLeft;
    offsetY = e.clientY - container.offsetTop;
    document.body.style.userSelect = 'none';
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
    document.body.style.userSelect = 'auto';
  });

  document.addEventListener('mousemove', (e) => {
    if (isDragging) {
      container.style.left = (e.clientX - offsetX) + 'px';
      container.style.top = (e.clientY - offsetY) + 'px';
      container.style.position = 'fixed';
    }
  });

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    alert('Your browser does not support Speech Recognition API.');
  } else {
    const recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-US';

    const startBtn = document.getElementById('startBtn');
    const clearBtn = document.getElementById('clearBtn');
    const closeBtn = document.getElementById('closeBtn');
    const notes = document.getElementById('notes');

    let isListening = false;

    // Load saved notes
    notes.textContent = localStorage.getItem('floatingSpeechNotes') || '';

    notes.addEventListener('input', () => {
      localStorage.setItem('floatingSpeechNotes', notes.textContent);
    });

    let previousFinal = '';

    recognition.onresult = (event) => {
      let finalTranscript = '';
      let interimTranscript = '';

      for (let i = event.resultIndex; i < event.results.length; i++) {
        const transcript = event.results[i][0].transcript.trim();
        if (event.results[i].isFinal) {
          // Avoid repeating the same final transcript
          if (transcript !== previousFinal) {
            finalTranscript += transcript + ' ';
            previousFinal = transcript;
          }
        } else {
          interimTranscript += transcript + ' ';
        }
      }

      if (finalTranscript) {
        notes.textContent += finalTranscript;
        notes.scrollTop = notes.scrollHeight;
        localStorage.setItem('floatingSpeechNotes', notes.textContent);
      }
    };

    recognition.onerror = (e) => {
      console.error('Speech recognition error:', e.error);
      if (['not-allowed', 'permission-denied'].includes(e.error)) {
        alert('Microphone permission denied.');
        if (isListening) toggleListening();
      }
    };

    recognition.onend = () => {
      if (isListening) recognition.start(); // resume only if active
    };

    function toggleListening() {
      if (!isListening) {
        recognition.start();
        startBtn.textContent = 'Stop';
        isListening = true;
      } else {
        recognition.stop();
        startBtn.textContent = 'Start';
        isListening = false;
      }
    }

    startBtn.addEventListener('click', toggleListening);

    clearBtn.addEventListener('click', () => {
      if (confirm('Clear all notes?')) {
        notes.textContent = '';
        localStorage.removeItem('floatingSpeechNotes');
        previousFinal = '';
      }
    });

    closeBtn.addEventListener('click', () => {
      window.close();
    });
  }
</script>

</body>
</html>
